{% extends 'core2/base.html' %}
{% load static %}

{% block title %}Mis Permisos - Portal Empleados{% endblock %}

{% block content %}
<main class="main-content">
    {% if messages %}
    {% for message in messages %}
    <section class="seccion {% if message.tags == 'success' %}msg-success{% elif message.tags == 'error' %}msg-error{% else %}msg-info{% endif %}">
        {{ message }}
    </section>
    {% endfor %}
    {% endif %}

    <section class="seccion texto-centro">
        <h2>Mis Permisos</h2>
        <p>Consulta el estado de tus solicitudes de permisos y solicita nuevos</p>
    </section>

    <!-- Bot√≥n para solicitar nuevo permiso -->
    <section class="seccion texto-centro">
        <a href="{% url 'solicitar_permiso' %}" class="button green">üìù Solicitar Nuevo Permiso</a>
    </section>

    <!-- Historial de Permisos -->
    <section class="seccion">
        <h3>Historial de Solicitudes</h3>
        {% if permisos %}
        <div style="overflow-x: auto;">
            <table class="table table--striped table--hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Tipo de Permiso</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>D√≠as Solicitados</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Fecha Solicitud</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for permiso in permisos %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <strong>{{ permiso.tipo_permiso.nombre }}</strong>
                            {% if permiso.tipo_permiso.descripcion %}
                                <br><small>{{ permiso.tipo_permiso.descripcion|truncatewords:8 }}</small>
                            {% endif %}
                        </td>
                        <td>{{ permiso.fecha_inicio|date:"d/m/Y" }}</td>
                        <td>{{ permiso.fecha_fin|date:"d/m/Y" }}</td>
                        <td><strong>{{ permiso.dias_solicitados }}</strong> d√≠a{{ permiso.dias_solicitados|pluralize }}</td>
                        <td>{{ permiso.motivo|truncatewords:10 }}</td>
                        <td>
                            {% if permiso.estado == 'PENDIENTE' %}
                                <span style="color: #ffc107; font-weight: bold;">‚è≥ Pendiente</span>
                            {% elif permiso.estado == 'APROBADO' %}
                                <span style="color: #43e97b; font-weight: bold;">‚úì Aprobado</span>
                            {% elif permiso.estado == 'RECHAZADO' %}
                                <span style="color: #f5576c; font-weight: bold;">‚úó Rechazado</span>
                            {% endif %}
                        </td>
                        <td>{{ permiso.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                        <td>
                            {% if permiso.observaciones %}
                                {{ permiso.observaciones|truncatewords:15 }}
                            {% else %}
                                <em style="color: #888;">-</em>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Estad√≠sticas -->
        <div class="cards-container" style="margin-top: 30px;">
            <div class="card">
                <h4 class="card-title">üìä Total de Solicitudes</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold;">
                    {{ permisos|length }}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">‚è≥ Pendientes</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #ffc107;">
                    {{ permisos|length }}
                    {# Este filtro debe hacerse en la vista para contar correctamente #}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">‚úì Aprobados</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #43e97b;">
                    0
                    {# Este filtro debe hacerse en la vista #}
                </p>
            </div>
        </div>
        {% else %}
        <div class="texto-centro">
            <p>No has solicitado ning√∫n permiso a√∫n.</p>
            <p>Puedes solicitar permisos para vacaciones, citas m√©dicas, asuntos personales y m√°s.</p>
            <a href="{% url 'solicitar_permiso' %}" class="button green" style="margin-top: 20px;">
                Solicitar Mi Primer Permiso
            </a>
        </div>
        {% endif %}
    </section>

    <!-- Informaci√≥n sobre Tipos de Permisos -->
    {% if tipos_permisos %}
    <section class="seccion">
        <h3>üìö Tipos de Permisos Disponibles</h3>
        <div class="cards-container">
            {% for tipo in tipos_permisos %}
            <div class="card">
                <h4 class="card-title">{{ tipo.nombre }}</h4>
                <p class="card-content">
                    {% if tipo.descripcion %}
                        {{ tipo.descripcion }}
                    {% else %}
                        Tipo de permiso {{ tipo.nombre|lower }}
                    {% endif %}
                </p>
                <p class="card-content">
                    {% if tipo.dias_maximos > 0 %}
                        <strong>D√≠as m√°ximos:</strong> {{ tipo.dias_maximos }}<br>
                    {% endif %}
                    <strong>Requiere aprobaci√≥n:</strong> {% if tipo.requiere_aprobacion %}S√≠{% else %}No{% endif %}
                </p>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Botones de acci√≥n -->
    <section class="seccion texto-centro">
        <a href="{% url 'solicitar_permiso' %}" class="button green">Solicitar Nuevo Permiso</a>
        <a href="{% url 'dashboard_empleado' %}" class="button">Volver al Dashboard</a>
    </section>
</main>
{% endblock %}