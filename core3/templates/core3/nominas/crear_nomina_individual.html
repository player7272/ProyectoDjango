{% extends 'core3/base_rrhh.html' %}
{% load static %}

{% block title %}Crear N√≥mina Individual - Recursos Humanos{% endblock %}

{% block content %}
<main class="main-content">
    <section class="seccion texto-centro">
        <h2>Crear N√≥mina Individual</h2>
        <p>Genera una n√≥mina espec√≠fica para {{ empleado.nombre }} {{ empleado.apellido }}</p>
    </section>

    <section class="seccion">
        <h3>Informaci√≥n del Empleado</h3>
        <div class="cards-container">
            <div class="card">
                <h4 class="card-title">üë§ Empleado</h4>
                <p class="card-content">
                    <strong>{{ empleado.nombre }} {{ empleado.apellido }}</strong><br>
                    <strong>C√©dula:</strong> {{ empleado.cedula }}<br>
                    <strong>Categor√≠a:</strong> {{ empleado.categoria.nombre|default:"No asignada" }}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üí∞ Salario Base</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #43e97b;">
                    {% if empleado.categoria %}
                        ${{ empleado.categoria.salario_base|floatformat:2 }}
                    {% else %}
                        <span style="color: #f5576c; font-size: 1.2rem;">Sin categor√≠a asignada</span>
                    {% endif %}
                </p>
                <p class="card-content">
                    <small>Este ser√° el salario base de la n√≥mina</small>
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üìä Estado</h4>
                <p class="card-content">
                    {% if empleado.activo %}
                        <span style="color: #43e97b; font-size: 1.5rem;">‚úì Activo</span>
                    {% else %}
                        <span style="color: #f5576c; font-size: 1.5rem;">‚óã Inactivo</span>
                    {% endif %}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üìã N√≥minas Previas</h4>
                <p class="card-content">
                    <strong>Total:</strong> {{ empleado.nominas.count }}<br>
                    <strong>Pagadas:</strong> {{ empleado.nominas.filter.count }}<br>
                    <strong>Pendientes:</strong> {{ nominas_pendientes }}
                </p>
            </div>
        </div>
    </section>

    {% if not empleado.categoria %}
    <section class="seccion">
        <div style="background: rgba(245, 87, 108, 0.2); padding: 20px; border-radius: 12px;">
            <h3 style="color: #f5576c;">‚ö†Ô∏è No se puede crear la n√≥mina</h3>
            <p>Este empleado no tiene una categor√≠a asignada. Debes asignar una categor√≠a antes de crear una n√≥mina.</p>
            <a href="{% url 'editar_empleado_rrhh' empleado.id %}" class="button blue">Asignar Categor√≠a</a>
            <a href="{% url 'detalle_empleado_rrhh' empleado.id %}" class="button">Volver al Perfil</a>
        </div>
    </section>
    {% else %}

    <section class="seccion">
        <h3>Seleccionar Periodo de N√≥mina</h3>
        
        {% if periodos_disponibles %}
        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <p><strong>Opci√≥n 1:</strong> Selecciona un periodo existente donde este empleado a√∫n no tiene n√≥mina</p>
        </div>

        <table class="table table--striped table--hover">
            <tbody>
                <tr>
                    <th>Periodo</th>
                    <th>Tipo</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Fecha Pago</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
                {% for periodo in periodos_disponibles %}
                <tr>
                    <td><strong>{{ periodo }}</strong></td>
                    <td>{{ periodo.get_tipo_display }}</td>
                    <td>{{ periodo.fecha_inicio|date:"d/m/Y" }}</td>
                    <td>{{ periodo.fecha_fin|date:"d/m/Y" }}</td>
                    <td>{{ periodo.fecha_pago|date:"d/m/Y" }}</td>
                    <td>
                        {% if periodo.cerrado %}
                            <span class="badge badge-secondary">Cerrado</span>
                        {% else %}
                            <span class="badge badge-success">Abierto</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="periodo_id" value="{{ periodo.id }}">
                            <button type="submit" class="button green" style="padding: 6px 12px; font-size: 13px;">
                                Usar Este Periodo
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="background: rgba(67, 227, 123, 0.1); padding: 20px; border-radius: 12px; margin-top: 30px;">
            <p><strong>Opci√≥n 2:</strong> O crea un nuevo periodo de n√≥mina</p>
            <a href="{% url 'crear_periodo_nomina' %}" class="button blue">Crear Nuevo Periodo</a>
        </div>

        {% else %}
        <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 12px;">
            <h4 style="margin-top: 0;">No hay periodos disponibles</h4>
            <p>No existen periodos donde este empleado no tenga n√≥mina, o no hay periodos creados.</p>
            <p><strong>Opciones:</strong></p>
            <ul>
                <li>Crea un nuevo periodo de n√≥mina</li>
                <li>Verifica las n√≥minas existentes del empleado</li>
            </ul>
            <div style="margin-top: 15px;">
                <a href="{% url 'crear_periodo_nomina' %}" class="button green">Crear Nuevo Periodo</a>
                <a href="{% url 'ver_todas_nominas_empleado' empleado.id %}" class="button blue">Ver N√≥minas Existentes</a>
            </div>
        </div>
        {% endif %}
    </section>

    <section class="seccion">
        <h3>üìã Proceso de Creaci√≥n de N√≥mina</h3>
        <div class="cards-container">
            <div class="card">
                <h4 class="card-title">1Ô∏è‚É£ Seleccionar Periodo</h4>
                <p class="card-content">
                    Elige un periodo existente o crea uno nuevo. El periodo define las fechas de pago y el tipo de n√≥mina.
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">2Ô∏è‚É£ Generaci√≥n Autom√°tica</h4>
                <p class="card-content">
                    La n√≥mina se crear√° autom√°ticamente con:<br>
                    ‚Ä¢ Salario base de la categor√≠a<br>
                    ‚Ä¢ Deducciones seg√∫n configuraci√≥n<br>
                    ‚Ä¢ Estado: Pendiente de pago
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">3Ô∏è‚É£ Edici√≥n y Ajustes</h4>
                <p class="card-content">
                    Despu√©s de crear la n√≥mina, podr√°s:<br>
                    ‚Ä¢ Agregar bonificaciones<br>
                    ‚Ä¢ Modificar deducciones<br>
                    ‚Ä¢ Agregar horas extra<br>
                    ‚Ä¢ A√±adir conceptos adicionales
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">4Ô∏è‚É£ Visibilidad</h4>
                <p class="card-content">
                    Una vez creada, la n√≥mina ser√° visible:<br>
                    ‚Ä¢ Para el empleado en su portal<br>
                    ‚Ä¢ En el listado de n√≥minas de RRHH<br>
                    ‚Ä¢ En el detalle del periodo
                </p>
            </div>
        </div>
    </section>

    {% if configuracion %}
    <section class="seccion">
        <h3>‚öôÔ∏è Configuraci√≥n de N√≥mina Actual</h3>
        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 12px;">
            <p><strong>La n√≥mina se crear√° con los siguientes par√°metros:</strong></p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                <div>
                    <strong>Salario Base:</strong><br>
                    ${{ empleado.categoria.salario_base|floatformat:2 }}
                </div>
                <div>
                    <strong>Seguridad Social ({{ configuracion.porcentaje_seguridad_social }}%):</strong><br>
                    ${% widthratio empleado.categoria.salario_base 100 configuracion.porcentaje_seguridad_social %}
                </div>
                <div>
                    <strong>Salud ({{ configuracion.porcentaje_salud }}%):</strong><br>
                    ${% widthratio empleado.categoria.salario_base 100 configuracion.porcentaje_salud %}
                </div>
                <div>
                    <strong>Pensi√≥n ({{ configuracion.porcentaje_pension }}%):</strong><br>
                    ${% widthratio empleado.categoria.salario_base 100 configuracion.porcentaje_pension %}
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(102, 126, 234, 0.3);">
                <strong>Total Deducciones Estimadas:</strong>
                <span style="color: #f5576c; font-size: 1.2rem; font-weight: bold;">
                    -${{ total_deducciones_estimadas|floatformat:2 }}
                </span>
            </div>
            <div style="margin-top: 10px;">
                <strong>Neto Estimado a Pagar:</strong>
                <span style="color: #43e97b; font-size: 1.5rem; font-weight: bold;">
                    ${{ neto_estimado|floatformat:2 }}
                </span>
            </div>
        </div>
    </section>
    {% else %}
    <section class="seccion">
        <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 12px;">
            <h4 style="margin-top: 0;">‚ö†Ô∏è No hay configuraci√≥n de n√≥mina activa</h4>
            <p>Se crear√° la n√≥mina con deducciones en $0.00. Puedes configurar los par√°metros de n√≥mina antes de continuar.</p>
            <a href="{% url 'configuracion_nomina' %}" class="button blue">Configurar N√≥mina</a>
        </div>
    </section>
    {% endif %}

    {% endif %}

    <section class="seccion texto-centro">
        <a href="{% url 'detalle_empleado_rrhh' empleado.id %}" class="button">Volver al Perfil del Empleado</a>
        <a href="{% url 'lista_empleados_rrhh' %}" class="button blue">Ver Todos los Empleados</a>
        <a href="{% url 'dashboard_rrhh' %}" class="button green">Ir al Dashboard</a>
    </section>
</main>
{% endblock %}