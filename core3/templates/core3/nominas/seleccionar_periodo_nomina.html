{% extends 'core3/base_rrhh.html' %}
{% load static %}

{% block title %}Seleccionar Periodo - Recursos Humanos{% endblock %}

{% block content %}
<main class="main-content">
    <section class="seccion texto-centro">
        <h2>Seleccionar Periodo de N√≥mina</h2>
        <p>Elige el periodo para crear la n√≥mina de {{ empleado.nombre }} {{ empleado.apellido }}</p>
    </section>

    <section class="seccion">
        <h3>Informaci√≥n del Empleado</h3>
        <div class="cards-container">
            <div class="card">
                <h4 class="card-title">üë§ Empleado</h4>
                <p class="card-content">
                    <strong>{{ empleado.nombre }} {{ empleado.apellido }}</strong><br>
                    <strong>C√©dula:</strong> {{ empleado.cedula }}<br>
                    <strong>Categor√≠a:</strong> {{ empleado.categoria.nombre|default:"No asignada" }}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üí∞ Salario Base</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #43e97b;">
                    {% if empleado.categoria %}
                        ${{ empleado.categoria.salario_base|floatformat:2 }}
                    {% else %}
                        <span style="color: #f5576c; font-size: 1.2rem;">Sin categor√≠a</span>
                    {% endif %}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üìä N√≥minas Existentes</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #4facfe;">
                    {{ empleado.nominas.count }}
                </p>
                <p class="card-content">N√≥minas procesadas</p>
            </div>
        </div>
    </section>

    {% if not empleado.categoria %}
    <section class="seccion">
        <div style="background: rgba(245, 87, 108, 0.2); padding: 20px; border-radius: 12px; text-align: center;">
            <h3 style="color: #f5576c;">‚ö†Ô∏è No se puede crear la n√≥mina</h3>
            <p>Este empleado no tiene una categor√≠a asignada. Debes asignar una categor√≠a antes de crear una n√≥mina.</p>
            <div style="margin-top: 20px;">
                <a href="{% url 'editar_empleado_rrhh' empleado.id %}" class="button blue">Asignar Categor√≠a</a>
                <a href="{% url 'detalle_empleado_rrhh' empleado.id %}" class="button">Volver al Perfil</a>
            </div>
        </div>
    </section>
    {% else %}

    <section class="seccion">
        <h3>Periodos Disponibles</h3>
        
        {% if periodos %}
        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <p><strong>‚ÑπÔ∏è Instrucciones:</strong></p>
            <ul style="line-height: 1.8; margin-top: 10px;">
                <li>Selecciona el periodo para el cual deseas crear la n√≥mina</li>
                <li>Solo se muestran periodos donde el empleado no tiene n√≥mina creada</li>
                <li>La n√≥mina se generar√° con el salario base de la categor√≠a actual</li>
                <li>Podr√°s editar bonificaciones y deducciones despu√©s de crearla</li>
            </ul>
        </div>

        <div style="overflow-x: auto;">
            <table class="table table--striped table--hover">
                <tbody>
                    <tr>
                        <th>Periodo</th>
                        <th>Tipo</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Fecha Pago</th>
                        <th>Estado</th>
                        <th>N√≥minas en Periodo</th>
                        <th>Acci√≥n</th>
                    </tr>
                    {% for periodo in periodos %}
                    <tr>
                        <td><strong>{{ periodo }}</strong></td>
                        <td>
                            <span class="badge badge-info">{{ periodo.get_tipo_display }}</span>
                        </td>
                        <td>{{ periodo.fecha_inicio|date:"d/m/Y" }}</td>
                        <td>{{ periodo.fecha_fin|date:"d/m/Y" }}</td>
                        <td>{{ periodo.fecha_pago|date:"d/m/Y" }}</td>
                        <td>
                            {% if periodo.cerrado %}
                                <span class="badge badge-secondary">üîí Cerrado</span>
                            {% else %}
                                <span class="badge badge-success">üîì Abierto</span>
                            {% endif %}
                        </td>
                        <td>{{ periodo.nominas.count }} n√≥minas</td>
                        <td>
                            <form method="POST" action="{% url 'crear_nomina_individual' empleado.id %}" style="display: inline;">
                                {% csrf_token %}
                            <input type="hidden" name="periodo" value="{{ periodo.id }}">
                            <button type="submit" class="button green" style="padding: 8px 16px; font-size: 14px;">
                                Usar Este Periodo
                            </button>
                        </form>

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="cards-container" style="margin-top: 30px;">
            <div class="card">
                <h4 class="card-title">üìä Periodos Disponibles</h4>
                <p class="card-content" style="font-size: 2rem; font-weight: bold; color: #4facfe;">
                    {{ periodos|length }}
                </p>
                <p class="card-content">Sin n√≥mina para este empleado</p>
            </div>

            <div class="card">
                <h4 class="card-title">üí∞ Salario a Generar</h4>
                <p class="card-content" style="font-size: 1.5rem; font-weight: bold; color: #43e97b;">
                    ${{ empleado.categoria.salario_base|floatformat:2 }}
                </p>
                <p class="card-content">
                    <small>Base inicial (antes de deducciones)</small>
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üìã Siguiente Paso</h4>
                <p class="card-content">
                    Al seleccionar un periodo:<br>
                    ‚Ä¢ Se crear√° la n√≥mina autom√°ticamente<br>
                    ‚Ä¢ Podr√°s editarla y agregar conceptos<br>
                    ‚Ä¢ Aplicar√°n las deducciones configuradas
                </p>
            </div>
        </div>

        {% else %}
        <div style="background: rgba(255, 193, 7, 0.1); padding: 30px; border-radius: 12px; text-align: center;">
            <h3 style="margin-top: 0;">‚ö†Ô∏è No hay periodos disponibles</h3>
            <p>No existen periodos de n√≥mina donde este empleado no tenga ya una n√≥mina creada.</p>
            
            <div style="margin-top: 20px;">
                <h4>Opciones:</h4>
                <ul style="text-align: left; display: inline-block; margin-top: 15px;">
                    <li>Crea un nuevo periodo de n√≥mina</li>
                    <li>Verifica las n√≥minas existentes del empleado</li>
                    <li>Si hay periodos pero no aparecen, es porque ya tienen n√≥mina</li>
                </ul>
            </div>

            <div style="margin-top: 30px;">
                <a href="{% url 'crear_periodo_nomina' %}" class="button green" style="margin: 5px;">
                    Crear Nuevo Periodo
                </a>
                <a href="{% url 'ver_todas_nominas_empleado' empleado.id %}" class="button blue" style="margin: 5px;">
                    Ver N√≥minas del Empleado
                </a>
                <a href="{% url 'lista_nominas_rrhh' %}" class="button" style="margin: 5px;">
                    Ver Todos los Periodos
                </a>
            </div>
        </div>
        {% endif %}
    </section>

    {% endif %}

    <section class="seccion">
        <h3>‚ÑπÔ∏è Informaci√≥n sobre la Creaci√≥n de N√≥minas</h3>
        <div class="cards-container">
            <div class="card">
                <h4 class="card-title">1Ô∏è‚É£ Selecci√≥n de Periodo</h4>
                <p class="card-content">
                    Elige el periodo de n√≥mina correspondiente. Solo se muestran periodos donde el empleado a√∫n no tiene n√≥mina.
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">2Ô∏è‚É£ Generaci√≥n Autom√°tica</h4>
                <p class="card-content">
                    La n√≥mina se generar√° con:<br>
                    ‚Ä¢ Salario base de la categor√≠a<br>
                    ‚Ä¢ Deducciones seg√∫n configuraci√≥n<br>
                    ‚Ä¢ Estado: Pendiente de pago
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">3Ô∏è‚É£ Personalizaci√≥n</h4>
                <p class="card-content">
                    Despu√©s de crear la n√≥mina podr√°s:<br>
                    ‚Ä¢ Agregar bonificaciones<br>
                    ‚Ä¢ Ajustar deducciones<br>
                    ‚Ä¢ A√±adir horas extra<br>
                    ‚Ä¢ Incluir conceptos adicionales
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">4Ô∏è‚É£ Visibilidad</h4>
                <p class="card-content">
                    Una vez creada, la n√≥mina ser√° visible para:<br>
                    ‚Ä¢ El empleado en su portal<br>
                    ‚Ä¢ Recursos humanos<br>
                    ‚Ä¢ Reportes del periodo
                </p>
            </div>
        </div>
    </section>

    <section class="seccion">
        <h3>üìå Recordatorios</h3>
        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 12px;">
            <ul style="line-height: 1.8;">
                <li><strong>Verificaci√≥n:</strong> Aseg√∫rate de que el salario base sea correcto antes de crear la n√≥mina</li>
                <li><strong>Periodo Correcto:</strong> Selecciona el periodo correspondiente al mes/quincena de pago</li>
                <li><strong>Deducciones:</strong> Las deducciones se aplicar√°n seg√∫n la configuraci√≥n activa del sistema</li>
                <li><strong>Edici√≥n:</strong> Puedes editar la n√≥mina despu√©s de crearla mientras no est√© marcada como pagada</li>
                <li><strong>Estado del Periodo:</strong> Si el periodo est√° cerrado, no se podr√°n hacer cambios</li>
            </ul>
        </div>
    </section>

    <section class="seccion texto-centro">
        <h3>Navegaci√≥n</h3>
        <div class="btn-group">
            <a href="{% url 'detalle_empleado_rrhh' empleado.id %}" class="button">Volver al Perfil del Empleado</a>
            <a href="{% url 'crear_periodo_nomina' %}" class="button blue">Crear Nuevo Periodo</a>
            <a href="{% url 'lista_empleados_rrhh' %}" class="button green">Ver Todos los Empleados</a>
            <a href="{% url 'dashboard_rrhh' %}" class="button">Ir al Dashboard</a>
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[action*="crear_nomina_individual"]');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const confirmed = confirm(
                '¬øEst√°s seguro de crear la n√≥mina para este periodo?\n\n' +
                'Se generar√° autom√°ticamente con el salario base y deducciones configuradas.'
            );
            
            if (!confirmed) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}