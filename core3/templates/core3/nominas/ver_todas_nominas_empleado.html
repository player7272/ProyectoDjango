{% extends 'core3/base_rrhh.html' %}
{% load static %}

{% block title %}N√≥minas de {{ empleado.nombre }} - Recursos Humanos{% endblock %}

{% block content %}
<main class="main-content">
    <section class="seccion">
        <h2>Todas las N√≥minas de {{ empleado.nombre }} {{ empleado.apellido }}</h2>
        <p>Historial completo de n√≥minas procesadas</p>
    </section>

    <!-- Informaci√≥n del Empleado -->
    <section class="seccion">
        <div class="cards-container">
            <div class="card">
                <h4 class="card-title">üë§ Empleado</h4>
                <p class="card-content">
                    <strong>{{ empleado.nombre }} {{ empleado.apellido }}</strong><br>
                    C√©dula: {{ empleado.cedula }}<br>
                    Categor√≠a: {{ empleado.categoria.nombre|default:"No asignada" }}
                </p>
            </div>

            <div class="card stat-card">
                <h4 class="card-title">üìä Total N√≥minas</h4>
                <div class="stat-number">{{ nominas|length }}</div>
                <div class="stat-label">N√≥minas procesadas</div>
            </div>

            <div class="card stat-card">
                <h4 class="card-title">üí∞ Total Pagado</h4>
                <div class="stat-number" style="color: #43e97b;">
                    ${{ total_pagado|floatformat:2 }}
                </div>
                <div class="stat-label">Total hist√≥rico</div>
            </div>

            <div class="card stat-card">
                <h4 class="card-title">‚è≥ Pendiente</h4>
                <div class="stat-number" style="color: #ffc107;">
                    ${{ total_pendiente|floatformat:2 }}
                </div>
                <div class="stat-label">Por pagar</div>
            </div>
        </div>
    </section>

    <!-- Tabla de N√≥minas -->
    <section class="seccion">
        {% if nominas %}
        <div style="overflow-x: auto;">
            <table class="table table--striped table--hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Periodo</th>
                        <th>Tipo</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>Fecha Pago</th>
                        <th>Salario Base</th>
                        <th>Bonificaciones</th>
                        <th>Deducciones</th>
                        <th>Neto a Pagar</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nomina in nominas %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><strong>{{ nomina.periodo }}</strong></td>
                        <td>{{ nomina.periodo.get_tipo_display }}</td>
                        <td>{{ nomina.periodo.fecha_inicio|date:"d/m/Y" }}</td>
                        <td>{{ nomina.periodo.fecha_fin|date:"d/m/Y" }}</td>
                        <td>{{ nomina.periodo.fecha_pago|date:"d/m/Y" }}</td>
                        <td>${{ nomina.salario_base|floatformat:2 }}</td>
                        <td style="color: #43e97b;">${{ nomina.bonificaciones|floatformat:2 }}</td>
                        <td style="color: #f5576c;">-${{ nomina.total_deducciones|floatformat:2 }}</td>
                        <td>
                            <strong style="color: #4facfe; font-size: 1.1rem;">
                                ${{ nomina.neto_pagar|floatformat:2 }}
                            </strong>
                        </td>
                        <td>
                            {% if nomina.pagado %}
                                <span class="badge badge-success">‚úì Pagado</span>
                            {% else %}
                                <span class="badge badge-warning">‚óã Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'editar_nomina' nomina.id %}" 
                               class="button blue" 
                               style="padding: 6px 12px; font-size: 13px;">
                                Ver/Editar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: rgba(102, 126, 234, 0.1);">
                        <td colspan="6" style="text-align: right; padding-right: 20px;">TOTALES:</td>
                        <td>${{ total_salarios_base|floatformat:2 }}</td>
                        <td style="color: #43e97b;">${{ total_bonificaciones|floatformat:2 }}</td>
                        <td style="color: #f5576c;">-${{ total_deducciones|floatformat:2 }}</td>
                        <td>
                            <strong style="color: #4facfe; font-size: 1.2rem;">
                                ${{ total_neto|floatformat:2 }}
                            </strong>
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Estad√≠sticas Adicionales -->
        <div class="cards-container" style="margin-top: 30px;">
            <div class="card">
                <h4 class="card-title">üìä Estad√≠sticas por Estado</h4>
                <p class="card-content">
                    <strong>Pagadas:</strong> {{ nominas_pagadas }} ({{ porcentaje_pagadas }}%)<br>
                    <strong>Pendientes:</strong> {{ nominas_pendientes }} ({{ porcentaje_pendientes }}%)
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üíµ Promedios</h4>
                <p class="card-content">
                    <strong>Salario Base Promedio:</strong> ${{ promedio_salario_base|floatformat:2 }}<br>
                    <strong>Neto Promedio:</strong> ${{ promedio_neto|floatformat:2 }}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">üìà √öltima N√≥mina</h4>
                <p class="card-content">
                    {% if nominas.first %}
                        <strong>Periodo:</strong> {{ nominas.first.periodo }}<br>
                        <strong>Neto:</strong> ${{ nominas.first.neto_pagar|floatformat:2 }}<br>
                        <strong>Estado:</strong> {% if nominas.first.pagado %}Pagado{% else %}Pendiente{% endif %}
                    {% else %}
                        Sin n√≥minas
                    {% endif %}
                </p>
            </div>

            <div class="card">
                <h4 class="card-title">‚è±Ô∏è Per√≠odo de An√°lisis</h4>
                <p class="card-content">
                    {% if nominas %}
                        <strong>Primera N√≥mina:</strong> {{ nominas.last.periodo.fecha_inicio|date:"d/m/Y" }}<br>
                        <strong>√öltima N√≥mina:</strong> {{ nominas.first.periodo.fecha_fin|date:"d/m/Y" }}<br>
                        <strong>Total Meses:</strong> {{ meses_totales|default:"N/A" }}
                    {% else %}
                        Sin datos
                    {% endif %}
                </p>
            </div>
        </div>

        {% else %}
        <div class="texto-centro">
            <p style="font-size: 1.2rem; margin: 40px 0;">No hay n√≥minas registradas para este empleado.</p>
            <a href="{% url 'crear_nomina_individual' empleado.id %}" class="button green">Crear Primera N√≥mina</a>
        </div>
        {% endif %}
    </section>

    <!-- Gr√°fico de Evoluci√≥n (Concepto) -->
    {% if nominas %}
    <section class="seccion">
        <h3>üìà Evoluci√≥n de N√≥minas</h3>
        <div style="background: rgba(79, 172, 254, 0.1); padding: 30px; border-radius: 12px;">
            <p style="text-align: center; color: #888;">
                <em>Gr√°fico de evoluci√≥n de n√≥minas a lo largo del tiempo</em><br>
                <small>(Esta funcionalidad puede implementarse con bibliotecas de gr√°ficos como Chart.js)</small>
            </p>
            
            <!-- Representaci√≥n textual de tendencia -->
            <div style="margin-top: 20px;">
                <h4>√öltimas 5 N√≥minas:</h4>
                {% for nomina in nominas|slice:":5" %}
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                    <span>{{ nomina.periodo }}</span>
                    <span style="font-weight: bold; color: #43e97b;">${{ nomina.neto_pagar|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Acciones -->
    <section class="seccion texto-centro">
        <h3>Acciones Disponibles</h3>
        <div class="btn-group">
            <a href="{% url 'crear_nomina_individual' empleado.id %}" class="button green">Crear Nueva N√≥mina</a>
            <a href="{% url 'detalle_empleado_rrhh' empleado.id %}" class="button blue">Ver Perfil del Empleado</a>
            <a href="{% url 'lista_empleados_rrhh' %}" class="button">Ver Todos los Empleados</a>
            <a href="{% url 'dashboard_rrhh' %}" class="button">Ir al Dashboard</a>
        </div>
    </section>
</main>
{% endblock %}